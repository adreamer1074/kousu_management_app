{% extends 'base.html' %}
{% load static %}

{% block title %}工数集計詳細 - {{ object.case_name.title }} | 工数管理システム{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .detail-label {
        font-weight: bold;
        color: #495057;
        min-width: 200px;
        flex-shrink: 0;
    }
    .detail-value {
        color: #212529;
        text-align: right;
        flex-grow: 1;
    }
    .status-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
    }
    .number-value {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 1.1rem;
    }
    .profit-positive { color: #28a745; }
    .profit-negative { color: #dc3545; }
    .profit-neutral { color: #6c757d; }
    
    .progress-card {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .workload-progress {
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
        height: 20px;
        margin-top: 0.5rem;
    }
    .workload-progress-bar {
        background: #28a745;
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    .workload-progress-bar.over-budget {
        background: #dc3545;
    }
    
    .action-buttons {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0.5rem;
        width: 10px;
        height: 10px;
        background: #007bff;
        border-radius: 50%;
    }
    .timeline-item.completed::before {
        background: #28a745;
    }
    .timeline-item.pending::before {
        background: #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ページヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-file-text text-primary"></i> 工数集計詳細
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:home' %}">ホーム</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'reports:report_list' %}">レポート</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'reports:workload_aggregation' %}">工数集計一覧</a></li>
                    <li class="breadcrumb-item active">詳細</li>
                </ol>
            </nav>
        </div>
        <div class="action-buttons">
            <a href="{% url 'reports:workload_aggregation' %}" class="btn btn-secondary me-2">
                <i class="bi bi-arrow-left"></i> 一覧に戻る
            </a>
            <a href="{% url 'reports:workload_aggregation_edit' object.pk %}" class="btn btn-primary me-2">
                <i class="bi bi-pencil"></i> 編集
            </a>
            <a href="{% url 'reports:workload_aggregation_delete' object.pk %}" class="btn btn-danger">
                <i class="bi bi-trash"></i> 削除
            </a>
        </div>
    </div>

    <div class="row">
        <!-- 左側: 基本情報 -->
        <div class="col-lg-8">
            <!-- プロジェクト基本情報 -->
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-info-circle text-info"></i> プロジェクト基本情報
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">プロジェクト名:</span>
                            <span class="detail-value">{{ object.project_name.name }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">チケット名:</span>
                            <span class="detail-value">{{ object.case_name.title }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">部署名:</span>
                            <span class="detail-value">{{ object.section.name|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">案件分類:</span>
                            <span class="detail-value">{{ object.get_case_classification_display }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">請求先:</span>
                            <span class="detail-value">{{ object.billing_destination|default:"-" }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">ステータス:</span>
                            <span class="detail-value">
                                {% if object.status == 'planning' %}
                                    <span class="badge bg-secondary status-badge">{{ object.get_status_display }}</span>
                                {% elif object.status == 'in_progress' %}
                                    <span class="badge bg-primary status-badge">{{ object.get_status_display }}</span>
                                {% elif object.status == 'completed' %}
                                    <span class="badge bg-success status-badge">{{ object.get_status_display }}</span>
                                {% elif object.status == 'inspection_waiting' %}
                                    <span class="badge bg-warning status-badge">{{ object.get_status_display }}</span>
                                {% elif object.status == 'inspected' %}
                                    <span class="badge bg-info status-badge">{{ object.get_status_display }}</span>
                                {% elif object.status == 'on_hold' %}
                                    <span class="badge bg-secondary status-badge">{{ object.get_status_display }}</span>
                                {% else %}
                                    <span class="badge bg-danger status-badge">{{ object.get_status_display }}</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">年月:</span>
                            <span class="detail-value">{{ object.year_month }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">作成者:</span>
                            <span class="detail-value">{{ object.created_by.username|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">作成日時:</span>
                            <span class="detail-value">{{ object.created_at|date:"Y年m月d日 H:i" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">更新日時:</span>
                            <span class="detail-value">{{ object.updated_at|date:"Y年m月d日 H:i" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 日程情報 -->
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-calendar text-warning"></i> 日程情報
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">見積日:</span>
                            <span class="detail-value">{{ object.estimate_date|date:"Y年m月d日"|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">受注日:</span>
                            <span class="detail-value">{{ object.order_date|date:"Y年m月d日"|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">開始予定日:</span>
                            <span class="detail-value">{{ object.planned_start_date|date:"Y年m月d日"|default:"-" }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">終了予定日:</span>
                            <span class="detail-value">{{ object.planned_end_date|date:"Y年m月d日"|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">実際終了日:</span>
                            <span class="detail-value">{{ object.actual_end_date|date:"Y年m月d日"|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">検収日:</span>
                            <span class="detail-value">{{ object.inspection_date|date:"Y年m月d日"|default:"-" }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- プロジェクトタイムライン -->
                <div class="mt-4">
                    <h6>プロジェクトタイムライン</h6>
                    <div class="mt-3">
                        <div class="timeline-item {% if object.estimate_date %}completed{% else %}pending{% endif %}">
                            <strong>見積</strong> - {{ object.estimate_date|date:"Y年m月d日"|default:"未設定" }}
                        </div>
                        <div class="timeline-item {% if object.order_date %}completed{% else %}pending{% endif %}">
                            <strong>受注</strong> - {{ object.order_date|date:"Y年m月d日"|default:"未設定" }}
                        </div>
                        <div class="timeline-item {% if object.actual_end_date %}completed{% elif object.status == 'in_progress' %}pending{% endif %}">
                            <strong>完了</strong> - {{ object.actual_end_date|date:"Y年m月d日"|default:"進行中" }}
                        </div>
                        <div class="timeline-item {% if object.inspection_date %}completed{% else %}pending{% endif %}">
                            <strong>検収</strong> - {{ object.inspection_date|date:"Y年m月d日"|default:"未設定" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 金額情報 -->
            <div class="detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-currency-yen text-success"></i> 金額情報
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">使用可能金額（税別）:</span>
                            <span class="detail-value number-value">¥{{ object.available_amount|floatformat:0 }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">請求金額（税別）:</span>
                            <span class="detail-value number-value">¥{{ object.billing_amount_excluding_tax|floatformat:0 }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">外注費（税別）:</span>
                            <span class="detail-value number-value">¥{{ object.outsourcing_cost_excluding_tax|floatformat:0 }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-row">
                            <span class="detail-label">残金額（税抜）:</span>
                            <span class="detail-value number-value 
                                {% if object.remaining_amount > 0 %}profit-positive
                                {% elif object.remaining_amount < 0 %}profit-negative
                                {% else %}profit-neutral{% endif %}">
                                ¥{{ object.remaining_amount|floatformat:0 }}
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">利益率:</span>
                            <span class="detail-value number-value
                                {% if object.profit_rate > 0 %}profit-positive
                                {% elif object.profit_rate < 0 %}profit-negative
                                {% else %}profit-neutral{% endif %}">
                                {{ object.profit_rate|floatformat:1 }}%
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">単価（万円/月）:</span>
                            <span class="detail-value number-value">{{ object.unit_cost_per_month|floatformat:2 }}万円</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側: 工数情報とアクション -->
        <div class="col-lg-4">
            <!-- 工数進捗カード -->
            <div class="progress-card">
                <h5 class="mb-3">
                    <i class="bi bi-clock text-white"></i> 工数進捗
                </h5>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>見積工数</span>
                        <span class="fw-bold">{{ object.estimated_workdays|floatformat:1 }}人日</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>使用工数</span>
                        <span class="fw-bold">{{ object.used_workdays|floatformat:1 }}人日</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>新入社員工数</span>
                        <span class="fw-bold">{{ object.newbie_workdays|floatformat:1 }}人日</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>残工数</span>
                        <span class="fw-bold">{{ object.remaining_workdays|floatformat:1 }}人日</span>
                    </div>
                </div>
                
                <!-- 進捗バー -->
                <div class="workload-progress">
                    {% if object.estimated_workdays > 0 %}
                        {% widthratio object.used_workdays object.estimated_workdays 100 as progress_percent %}
                        <div class="workload-progress-bar {% if progress_percent > 100 %}over-budget{% endif %}" 
                             style="width: {% if progress_percent > 100 %}100{% else %}{{ progress_percent }}{% endif %}%">
                        </div>
                    {% endif %}
                </div>
                
                <div class="mt-2 text-center">
                    {% if object.estimated_workdays > 0 %}
                        {% widthratio object.used_workdays object.estimated_workdays 100 as progress_percent %}
                        <small>進捗: {{ progress_percent }}%</small>
                    {% else %}
                        <small>見積工数未設定</small>
                    {% endif %}
                </div>
            </div>

            <!-- 担当者情報 -->
            <div class="detail-card">
                <h6 class="mb-3">
                    <i class="bi bi-people text-info"></i> 担当者情報
                </h6>
                
                <div class="detail-row">
                    <span class="detail-label">MUB管理者:</span>
                    <span class="detail-value">{{ object.mub_manager.username|default:"-" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">営業担当:</span>
                    <span class="detail-value">{{ object.sales_rep|default:"-" }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">運用担当:</span>
                    <span class="detail-value">{{ object.operations_rep|default:"-" }}</span>
                </div>
            </div>

            <!-- その他情報 -->
            <div class="detail-card">
                <h6 class="mb-3">
                    <i class="bi bi-info-square text-secondary"></i> その他情報
                </h6>
                
                <div class="detail-row">
                    <span class="detail-label">備考:</span>
                    <span class="detail-value">{{ object.remarks|default:"-" }}</span>
                </div>
            </div>

            <!-- アクションボタン（モバイル対応） -->
            <div class="d-lg-none">
                <div class="detail-card">
                    <div class="d-grid gap-2">
                        <a href="{% url 'reports:workload_aggregation_edit' object.pk %}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> 編集
                        </a>
                        <a href="{% url 'reports:workload_aggregation_delete' object.pk %}" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> 削除
                        </a>
                        <a href="{% url 'reports:workload_aggregation' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 一覧に戻る
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 工数進捗のアニメーション
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.workload-progress-bar');
    if (progressBar) {
        const targetWidth = progressBar.style.width;
        progressBar.style.width = '0%';
        setTimeout(() => {
            progressBar.style.width = targetWidth;
        }, 500);
    }
});

// 削除ボタンの確認
document.addEventListener('DOMContentLoaded', function() {
    const deleteLinks = document.querySelectorAll('a[href*="delete"]');
    deleteLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (!confirm('本当に削除しますか？この操作により、データは一覧から非表示になります。')) {
                e.preventDefault();
            }
        });
    });
});

// 数値のフォーマット（カンマ区切り）
document.addEventListener('DOMContentLoaded', function() {
    const numberElements = document.querySelectorAll('.number-value');
    numberElements.forEach(element => {
        if (element.textContent.includes('¥')) {
            // 金額の場合のフォーマット処理（必要に応じて）
        }
    });
});
</script>
{% endblock %}