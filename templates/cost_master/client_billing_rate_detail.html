{% extends 'base.html' %}
{% load static %}

{% block title %}{{ client_rate.client_name }} - 詳細 | 工数管理システム{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 2rem;
    }
    .info-item {
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 0;
    }
    .info-item:last-child {
        border-bottom: none;
    }
    .badge-large {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ページヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-people"></i> 取引先詳細
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'cost_master:client_billing_rate_list' %}">取引先一覧</a></li>
                    <li class="breadcrumb-item active">{{ client_rate.client_name }}</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{% url 'cost_master:client_billing_rate_edit' client_rate.pk %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> 編集
            </a>
            <a href="{% url 'cost_master:client_billing_rate_create' %}?copy={{ client_rate.pk }}" class="btn btn-outline-primary">
                <i class="bi bi-copy"></i> 複製
            </a>
            <a href="{% url 'cost_master:client_billing_rate_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 一覧に戻る
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- 基本情報カード -->
            <div class="detail-card">
                <div class="detail-header">
                    <h2 class="mb-1">{{ client_rate.client_name }}</h2>
                    <p class="mb-0 opacity-75">取引先基本情報</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold">対象部署</label>
                                <div>
                                    {% if client_rate.department %}
                                        <span class="badge bg-info badge-large">{{ client_rate.department.name }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary badge-large">全部署対象</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold">社員レベル</label>
                                <div>
                                    {% if client_rate.employee_level %}
                                        <span class="badge bg-primary badge-large">{{ client_rate.get_employee_level_display }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary badge-large">全レベル対象</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold">契約タイプ</label>
                                <div>
                                    <span class="badge bg-success badge-large">{{ client_rate.get_contract_type_display }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold">ステータス</label>
                                <div>
                                    {% if client_rate.is_active %}
                                        <span class="badge bg-success badge-large">有効</span>
                                    {% else %}
                                        <span class="badge bg-danger badge-large">無効</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 請求単価カード -->
            {% if client_rate.billing_type %}
            <div class="detail-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-currency-yen"></i> 請求単価情報</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>請求タイプ:</strong> {{ client_rate.get_billing_type_display }}
                    </div>
                    
                    <div class="row">
                        {% if client_rate.monthly_billing %}
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>月額請求単価</h6>
                                    <h4 class="text-primary">{{ client_rate.monthly_billing|floatformat:1 }}万円</h4>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if client_rate.daily_billing %}
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>日額請求単価</h6>
                                    <h4 class="text-success">{{ client_rate.daily_billing|floatformat:1 }}万円</h4>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if client_rate.hourly_billing %}
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>時間請求単価</h6>
                                    <h4 class="text-warning">{{ client_rate.hourly_billing|floatformat:0 }}円</h4>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if client_rate.fixed_billing %}
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>固定請求料金</h6>
                                    <h4 class="text-info">{{ client_rate.fixed_billing|floatformat:1 }}万円</h4>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 換算表示 -->
                    {% if conversions.monthly %}
                    <div class="mt-4">
                        <h6><i class="bi bi-calculator"></i> 単価換算表</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>月額換算</td>
                                    <td class="text-end fw-bold">{{ conversions.monthly|floatformat:1 }} 万円</td>
                                </tr>
                                {% if conversions.daily %}
                                <tr>
                                    <td>日額換算</td>
                                    <td class="text-end fw-bold">{{ conversions.daily|floatformat:2 }} 万円</td>
                                </tr>
                                {% endif %}
                                {% if conversions.hourly %}
                                <tr>
                                    <td>時間換算</td>
                                    <td class="text-end fw-bold">{{ conversions.hourly|floatformat:0 }} 円</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                        <small class="text-muted">※ 月20日、1日8時間で換算</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 割引・条件カード -->
            <div class="detail-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-percent"></i> 割引・条件情報</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold">割引率</label>
                                <div>
                                    {% if client_rate.discount_rate > 0 %}
                                        <span class="badge bg-warning badge-large">{{ client_rate.discount_rate }}%</span>
                                    {% else %}
                                        <span class="text-muted">割引なし</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold">最低請求金額</label>
                                <div>{{ client_rate.minimum_billing_amount|floatformat:1 }}万円</div>
                            </div>
                        </div>
                        {% if client_rate.payment_terms %}
                        <div class="col-md-12">
                            <div class="info-item">
                                <label class="form-label fw-bold">支払い条件</label>
                                <div>{{ client_rate.payment_terms }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- 有効期間カード -->
            <div class="detail-card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-calendar-range"></i> 有効期間</h6>
                </div>
                <div class="card-body">
                    <p><strong>開始日:</strong> {{ client_rate.effective_from|date:"Y年m月d日" }}</p>
                    <p><strong>終了日:</strong> 
                        {% if client_rate.effective_to %}
                            {{ client_rate.effective_to|date:"Y年m月d日" }}
                        {% else %}
                            無期限
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- 関連情報カード -->
            <div class="detail-card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> 関連情報</h6>
                </div>
                <div class="card-body">
                    <p><strong>関連プロジェクト:</strong> {{ related_projects_count }} 件</p>
                    <p><strong>登録日:</strong> {{ client_rate.created_at|date:"Y年m月d日" }}</p>
                    <p><strong>最終更新:</strong> {{ client_rate.updated_at|date:"Y年m月d日" }}</p>
                </div>
            </div>

            <!-- アクションカード -->
            <div class="detail-card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-gear"></i> アクション</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'cost_master:client_billing_rate_edit' client_rate.pk %}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> 編集
                        </a>
                        <a href="{% url 'cost_master:client_billing_rate_create' %}?copy={{ client_rate.pk }}" class="btn btn-outline-primary">
                            <i class="bi bi-copy"></i> 複製
                        </a>
                        <hr>
                        <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                            <i class="bi bi-trash"></i> 削除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete() {
    if (confirm('取引先「{{ client_rate.client_name }}」を削除しますか？\nこの操作は取り消せません。')) {
        window.location.href = "{% url 'cost_master:client_billing_rate_delete' client_rate.pk %}";
    }
}
</script>
{% endblock %}