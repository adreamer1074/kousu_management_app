{% extends 'base.html' %}
{% load static %}

{% block title %}コストマスター - 新規作成 | 工数管理システム{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #fff;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-section h5 {
        color: #495057;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .billing-type-section {
        display: none;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        background: #f8f9fa;
    }
    .billing-type-section.active {
        display: block;
    }
    .preview-card {
        background: #fff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky;
        top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ページヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-gear"></i> コストマスター - 新規作成
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'cost_master:cost_master_list' %}">コストマスター一覧</a></li>
                    <li class="breadcrumb-item active">新規作成</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{% url 'cost_master:cost_master_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 一覧に戻る
            </a>
        </div>
    </div>

    <form method="post" id="costMasterForm">
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-8">
                <!-- 基本情報セクション -->
                <div class="form-section">
                    <h5><i class="bi bi-info-circle"></i> 基本情報</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.client_name.id_for_label }}" class="form-label required-field">
                                請求先
                            </label>
                            {{ form.client_name }}
                            {% if form.client_name.errors %}
                                <div class="text-danger small mt-1">{{ form.client_name.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">取引先の正式名称を入力してください</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.billing_type.id_for_label }}" class="form-label required-field">
                                請求タイプ
                            </label>
                            {{ form.billing_type }}
                            {% if form.billing_type.errors %}
                                <div class="text-danger small mt-1">{{ form.billing_type.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">選択したタイプに応じて入力項目が変わります</div>
                        </div>
                    </div>
                </div>

                <!-- 対象設定セクション -->
                <div class="form-section">
                    <h5><i class="bi bi-people"></i> 対象設定</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.department.id_for_label }}" class="form-label">
                                対象部署
                            </label>
                            {{ form.department }}
                            {% if form.department.errors %}
                                <div class="text-danger small mt-1">{{ form.department.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">設定しない場合は全部署が対象</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.manager.id_for_label }}" class="form-label">
                                責任者
                            </label>
                            {{ form.manager }}
                            {% if form.manager.errors %}
                                <div class="text-danger small mt-1">{{ form.manager.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">案件の責任者を設定</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.employee_level.id_for_label }}" class="form-label">
                                社員レベル
                            </label>
                            {{ form.employee_level }}
                            {% if form.employee_level.errors %}
                                <div class="text-danger small mt-1">{{ form.employee_level.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">対象となる社員レベル</div>
                        </div>
                    </div>
                </div>

                <!-- 請求単価設定セクション -->
                <div class="form-section">
                    <h5><i class="bi bi-currency-yen"></i> 請求単価設定</h5>
                    
                    <!-- 月額請求 -->
                    <div class="billing-type-section monthly" id="monthly-section">
                        <h6 class="text-primary"><i class="bi bi-calendar-month"></i> 月額請求単価</h6>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.monthly_billing.id_for_label }}" class="form-label required-field">
                                月額請求単価（万円）
                            </label>
                            {{ form.monthly_billing }}
                            {% if form.monthly_billing.errors %}
                                <div class="text-danger small mt-1">{{ form.monthly_billing.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 日額請求 -->
                    <div class="billing-type-section daily" id="daily-section">
                        <h6 class="text-success"><i class="bi bi-calendar-day"></i> 日額請求単価</h6>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.daily_billing.id_for_label }}" class="form-label required-field">
                                日額請求単価（万円）
                            </label>
                            {{ form.daily_billing }}
                            {% if form.daily_billing.errors %}
                                <div class="text-danger small mt-1">{{ form.daily_billing.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 時間請求 -->
                    <div class="billing-type-section hourly" id="hourly-section">
                        <h6 class="text-warning"><i class="bi bi-clock"></i> 時間請求単価</h6>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.hourly_billing.id_for_label }}" class="form-label required-field">
                                時間請求単価（円）
                            </label>
                            {{ form.hourly_billing }}
                            {% if form.hourly_billing.errors %}
                                <div class="text-danger small mt-1">{{ form.hourly_billing.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 固定料金 -->
                    <div class="billing-type-section fixed" id="fixed-section">
                        <h6 class="text-info"><i class="bi bi-cash-stack"></i> 固定請求料金</h6>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fixed_billing.id_for_label }}" class="form-label required-field">
                                固定請求料金（万円）
                            </label>
                            {{ form.fixed_billing }}
                            {% if form.fixed_billing.errors %}
                                <div class="text-danger small mt-1">{{ form.fixed_billing.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 割引・特別条件セクション -->
                <div class="form-section">
                    <h5><i class="bi bi-percent"></i> 割引・特別条件</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.discount_rate.id_for_label }}" class="form-label">
                                割引率（%）
                            </label>
                            {{ form.discount_rate }}
                            {% if form.discount_rate.errors %}
                                <div class="text-danger small mt-1">{{ form.discount_rate.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">0-100の範囲で入力</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.minimum_billing_amount.id_for_label }}" class="form-label">
                                最低請求金額（万円）
                            </label>
                            {{ form.minimum_billing_amount }}
                            {% if form.minimum_billing_amount.errors %}
                                <div class="text-danger small mt-1">{{ form.minimum_billing_amount.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">設定しない場合は制限なし</div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.special_conditions.id_for_label }}" class="form-label">
                                特別条件
                            </label>
                            {{ form.special_conditions }}
                            {% if form.special_conditions.errors %}
                                <div class="text-danger small mt-1">{{ form.special_conditions.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">割引条件や特別な取り決めなど</div>
                        </div>
                    </div>
                </div>

                <!-- 契約条件セクション -->
                <div class="form-section">
                    <h5><i class="bi bi-file-contract"></i> 契約条件</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.contract_type.id_for_label }}" class="form-label">
                                契約タイプ
                            </label>
                            {{ form.contract_type }}
                            {% if form.contract_type.errors %}
                                <div class="text-danger small mt-1">{{ form.contract_type.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.payment_terms.id_for_label }}" class="form-label">
                                支払い条件
                            </label>
                            {{ form.payment_terms }}
                            {% if form.payment_terms.errors %}
                                <div class="text-danger small mt-1">{{ form.payment_terms.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">例：月末締め翌月末払い</div>
                        </div>
                    </div>
                </div>

                <!-- 有効期間セクション -->
                <div class="form-section">
                    <h5><i class="bi bi-calendar-range"></i> 有効期間</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.effective_from.id_for_label }}" class="form-label">
                                有効開始日
                            </label>
                            {{ form.effective_from }}
                            {% if form.effective_from.errors %}
                                <div class="text-danger small mt-1">{{ form.effective_from.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.effective_to.id_for_label }}" class="form-label">
                                有効終了日
                            </label>
                            {{ form.effective_to }}
                            {% if form.effective_to.errors %}
                                <div class="text-danger small mt-1">{{ form.effective_to.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">空の場合は無期限</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check mt-4">
                                {{ form.is_active }}
                                <label for="{{ form.is_active.id_for_label }}" class="form-check-label">
                                    有効
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- フォームエラー表示 -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
                {% endif %}

                <!-- 保存ボタン -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'cost_master:cost_master_list' %}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> キャンセル
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 保存
                    </button>
                </div>
            </div>

            <!-- 右カラム: プレビュー -->
            <div class="col-lg-4">
                <div class="preview-card">
                    <h6><i class="bi bi-eye"></i> 設定プレビュー</h6>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <small class="text-muted">請求先</small>
                            <div class="h6" id="preview-client">未入力</div>
                        </div>
                        <div class="col-12 mb-2">
                            <small class="text-muted">請求タイプ</small>
                            <div id="preview-billing-type">未選択</div>
                        </div>
                        <div class="col-12 mb-2">
                            <small class="text-muted">請求金額</small>
                            <div id="preview-amount">-</div>
                        </div>
                        <div class="col-12 mb-2">
                            <small class="text-muted">割引後金額</small>
                            <div id="preview-discounted" class="text-success">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const billingTypeField = document.getElementById('id_billing_type');
    const billingTypeSections = document.querySelectorAll('.billing-type-section');
    
    // 請求タイプ変更時の処理
    function toggleBillingTypeSection() {
        const selectedType = billingTypeField.value;
        
        billingTypeSections.forEach(section => {
            section.classList.remove('active');
        });
        
        if (selectedType) {
            const targetSection = document.getElementById(selectedType + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }
        
        updatePreview();
    }
    
    // プレビュー更新
    function updatePreview() {
        const clientName = document.getElementById('id_client_name').value || '未入力';
        const billingType = document.getElementById('id_billing_type');
        const discountRate = parseFloat(document.getElementById('id_discount_rate').value) || 0;
        
        document.getElementById('preview-client').textContent = clientName;
        
        if (billingType.value) {
            const selectedOption = billingType.options[billingType.selectedIndex];
            document.getElementById('preview-billing-type').textContent = selectedOption.text;
            
            // 請求金額の表示
            let amount = 0;
            let unit = '';
            
            switch (billingType.value) {
                case 'monthly':
                    amount = parseFloat(document.getElementById('id_monthly_billing').value) || 0;
                    unit = '万円/月';
                    break;
                case 'daily':
                    amount = parseFloat(document.getElementById('id_daily_billing').value) || 0;
                    unit = '万円/日';
                    break;
                case 'hourly':
                    amount = parseFloat(document.getElementById('id_hourly_billing').value) || 0;
                    unit = '円/時間';
                    break;
                case 'fixed':
                    amount = parseFloat(document.getElementById('id_fixed_billing').value) || 0;
                    unit = '万円';
                    break;
            }
            
            if (amount > 0) {
                document.getElementById('preview-amount').textContent = amount.toLocaleString() + unit;
                
                // 割引後金額の計算
                if (discountRate > 0) {
                    const discounted = amount * (1 - discountRate / 100);
                    document.getElementById('preview-discounted').textContent = 
                        discounted.toLocaleString() + unit + ` (${discountRate}%割引)`;
                } else {
                    document.getElementById('preview-discounted').textContent = '割引なし';
                }
            } else {
                document.getElementById('preview-amount').textContent = '-';
                document.getElementById('preview-discounted').textContent = '-';
            }
        } else {
            document.getElementById('preview-billing-type').textContent = '未選択';
            document.getElementById('preview-amount').textContent = '-';
            document.getElementById('preview-discounted').textContent = '-';
        }
    }
    
    // イベントリスナー設定
    if (billingTypeField) {
        billingTypeField.addEventListener('change', toggleBillingTypeSection);
    }
    
    // 入力フィールドの変更監視
    const fieldsToWatch = [
        'id_client_name', 'id_billing_type', 'id_monthly_billing', 
        'id_daily_billing', 'id_hourly_billing', 'id_fixed_billing', 'id_discount_rate'
    ];
    
    fieldsToWatch.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', updatePreview);
            field.addEventListener('input', updatePreview);
        }
    });
    
    // 初期表示
    toggleBillingTypeSection();
    updatePreview();
});
</script>
{% endblock %}