{% extends 'base.html' %}
{% load static %}

{% block title %}ãƒã‚¤ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | å·¥æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    .card-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    .welcome-section {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .progress-custom {
        height: 8px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="welcome-section">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-3">
                    ãŠã‹ãˆã‚Šãªã•ã„ã€{{ user.get_full_name|default:user.username }}ã•ã‚“
                </h1>
                <p class="lead mb-0">
                    {% if today_workload_exists %}
                        ä»Šæ—¥ã®å·¥æ•°å…¥åŠ›æ¸ˆã¿ âœ… ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼
                    {% else %}
                        ä»Šæ—¥ã®å·¥æ•°å…¥åŠ›ã‚’ãŠå¿˜ã‚Œãªã ğŸ“
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <i class="bi bi-person-workspace" style="font-size: 5rem; opacity: 0.3;"></i>
            </div>
        </div>
    </div>

    <!-- ä»Šæ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    {% if not today_workload_exists %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <strong>ä»Šæ—¥ã®å·¥æ•°ãŒã¾ã å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</strong>
                        <p class="mb-0 small">{{ today|date:"Yå¹´mæœˆdæ—¥" }}ã®ä½œæ¥­å†…å®¹ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
                    </div>
                    <div>
                        <a href="{% url 'workloads:workload_calendar' %}" class="btn btn-warning">
                            <i class="bi bi-plus-circle"></i> ä»Šã™ãå…¥åŠ›
                        </a>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- å€‹äººç”¨ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ -->
    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="card dashboard-card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-calendar-event text-primary card-icon"></i>
                    <h5 class="card-title">å·¥æ•°å…¥åŠ›</h5>
                    <p class="card-text">å·¥æ•°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§å…¥åŠ›</p>
                    <a href="{% url 'workloads:workload_calendar' %}" class="btn btn-primary btn-lg">
                        å·¥æ•°ã‚’å…¥åŠ›
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card dashboard-card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-clock-history text-success card-icon"></i>
                    <h5 class="card-title">å·¥æ•°é›†è¨ˆ</h5>
                    <p class="card-text">å·¥æ•°ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª</p>
                    <a href="{% url 'reports:workload_aggregation' %}" class="btn btn-success">
                        é›†è¨ˆã‚’è¦‹ã‚‹
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6">
            <div class="card dashboard-card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-person-circle text-info card-icon"></i>
                    <h5 class="card-title">ãƒã‚¤ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h5>
                    <p class="card-text">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†</p>
                    <a href="{% url 'users:profile' %}" class="btn btn-info">
                        ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- å€‹äººçµ±è¨ˆæƒ…å ± -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> ä»Šæœˆã®æ´»å‹•çŠ¶æ³
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-primary">{{ this_month_hours }}</div>
                                <small class="text-muted">ä»Šæœˆã®å·¥æ•°ï¼ˆæ™‚é–“ï¼‰</small>
                                <div class="progress progress-custom mt-2">
                                    <div class="progress-bar bg-primary" style="width: {% widthratio this_month_hours 160 100 %}%"></div>
                                </div>
                                <small class="text-muted">ç›®æ¨™: 160h</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-success">{{ this_week_hours }}</div>
                                <small class="text-muted">ä»Šé€±ã®å·¥æ•°ï¼ˆæ™‚é–“ï¼‰</small>
                                <div class="progress progress-custom mt-2">
                                    <div class="progress-bar bg-success" style="width: {% widthratio this_week_hours 40 100 %}%"></div>
                                </div>
                                <small class="text-muted">ç›®æ¨™: 40h</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-info">{{ my_projects.count }}</div>
                                <small class="text-muted">å‚åŠ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</small>
                                <div class="mt-2">
                                    {% if my_projects.count > 0 %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-dash-circle text-muted"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-warning">{{ pending_tasks.count }}</div>
                                <small class="text-muted">æœªå…¥åŠ›æ—¥æ•°</small>
                                <div class="mt-2">
                                    {% if pending_tasks.count == 0 %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-exclamation-circle text-warning"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock"></i> æœ€è¿‘ã®å·¥æ•°å…¥åŠ›
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_workloads %}
                        {% for workload in recent_workloads %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                            <div>
                                <strong>{{ workload.project.name|truncatechars:20 }}</strong><br>
                                <small class="text-muted">{{ workload.year_month|date:"Yå¹´mæœˆ" }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ workload.total_hours|default:"0" }}h</span><br>
                                <small class="text-muted">{{ workload.updated_at|date:"m/d" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-clock" style="font-size: 2rem;"></i>
                            <p class="mb-0 mt-2">å·¥æ•°å…¥åŠ›å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <small>å·¥æ•°ã‚’å…¥åŠ›ã—ã¦é–‹å§‹ã—ã¾ã—ã‚‡ã†</small>
                        </div>
                    {% endif %}
                    
                    <div class="d-grid mt-3">
                        <a href="{% url 'workloads:workload_calendar' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-plus-circle"></i> å·¥æ•°ã‚’å…¥åŠ›
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‚åŠ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ -->
    {% if my_projects %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-folder"></i> å‚åŠ ä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for project in my_projects %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="border rounded p-3 h-100">
                                <h6 class="mb-2">{{ project.name }}</h6>
                                <p class="small text-muted mb-2">{{ project.description|truncatechars:80 }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        é–‹å§‹: {{ project.start_date|date:"Y/m/d" }}
                                    </small>
                                    <span class="badge bg-{{ project.is_active|yesno:'success,secondary' }}">
                                        {{ project.is_active|yesno:'é€²è¡Œä¸­,å®Œäº†' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å®Œäº†');
    
    // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    const thisMonthHours = {{ this_month_hours|default:0 }};
    const thisWeekHours = {{ this_week_hours|default:0 }};
    
    console.log('ä»Šæœˆã®å·¥æ•°:', thisMonthHours + 'h');
    console.log('ä»Šé€±ã®å·¥æ•°:', thisWeekHours + 'h');
});
</script>
{% endblock %}