{% extends 'base.html' %}
{% load workload_filters %}

{% block title %}工数管理 - 工数管理システム{% endblock %}

{% block page_title %}
    <i class="bi bi-calendar-event"></i> 工数カレンダー
    <span class="badge bg-primary ms-2">{{ year }}年{{ month }}月</span>
{% endblock %}

{% block extra_css %}
<style>
    .workload-table {
        font-size: 0.9em;
        border-collapse: collapse;
        table-layout: fixed;
        width: 100%;
        min-width: 1400px; /* 最小幅を確保 */
    }
    
    .workload-table th,
    .workload-table td {
        border: 1px solid #dee2e6;
        padding: 6px 4px;
        text-align: center;
        vertical-align: middle;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .workload-table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        font-weight: bold;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* 課列 */
    .department-col {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        text-align: left;
        padding-left: 8px !important;
        background-color: #f1f3f4;
        position: sticky;
        left: 0;
        z-index: 5;
        border-right: 2px solid #dee2e6;
    }
    
    .department-col.sticky-header {
        z-index: 15;
        background: linear-gradient(135deg, #f1f3f4 0%, #e2e6ea 100%);
    }
    
    /* 担当者列 */
    .user-col {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
        text-align: left;
        padding-left: 8px !important;
        background-color: #f8f9fa;
        position: sticky;
        left: 80px; /* 部署列の幅分ずらす */
        z-index: 5;
        border-right: 2px solid #dee2e6;
    }
    
    .user-col.sticky-header {
        z-index: 15;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    /* チケット列 */
    .ticket-col {
        width: 200px;
        min-width: 200px;
        max-width: 200px;
        text-align: left;
        padding-left: 8px !important;
        background-color: #fff;
        position: sticky;
        left: 200px;
        z-index: 5;
        border-right: 2px solid #dee2e6;
    }
    
    .ticket-col.sticky-header {
        z-index: 15;
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    }
    
    /* 工数計列（人日）*/
    .total-days-col {
        width: 70px;
        min-width: 70px;
        max-width: 70px;
        background-color: #e8f4f8;
        font-weight: bold;
        position: sticky;
        left: 400px; /* 前の列までの合計幅 */
        z-index: 5;
        border-right: 2px solid #dee2e6;
    }
    
    .total-days-col.sticky-header {
        z-index: 15;
        background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
    }
    
    /* 工数計列（人時）*/
    .total-hours-col {
        width: 70px;
        min-width: 70px;
        max-width: 70px;
        background-color: #e8f4f8;
        font-weight: bold;
        position: sticky;
        left: 470px; /* 前の列までの合計幅 */
        z-index: 5;
        border-right: 3px solid #007bff; /* 最後の固定列は目立たせる */
    }
    
    .total-hours-col.sticky-header {
        z-index: 15;
        background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
    }
    
    /* 日付列 */
    .day-col {
        width: 45px;
        min-width: 45px;
        max-width: 45px;
        text-align: center;
    }

    .day-header {
        font-size: 0.85em;
        font-weight: bold;
        writing-mode: horizontal-tb; /* 縦書きから横書きに変更 */
        text-orientation: mixed; /* upright から mixed に変更 */
        height: 40px; /* 高さを調整 */
        line-height: 1.4;
        padding: 8px 4px; /* パディングを調整 */
    }
    
    /* 操作列 */
    .action-col {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
        background-color: #f8f9fa;
    }
    
    /* 入力フィールド */
    .workload-input {
        width: 38px;
        height: 28px;
        border: 1px solid #ced4da;
        text-align: center;
        font-size: 0.85em;
        padding: 2px;
        border-radius: 3px;
        background-color: #fff;
        transition: all 0.2s ease;
    }
    
    .workload-input::-webkit-outer-spin-button,
    .workload-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    .workload-input[type=number] {
        -moz-appearance: textfield;
    }
    
    .workload-input:focus {
        background-color: #fff3cd;
        outline: 2px solid #ffc107;
        border-color: #ffc107;
        transform: scale(1.05);
    }
    
    .workload-input.has-value {
        background-color: #d1ecf1;
        font-weight: bold;
        color: #0c5460;
        border-color: #17a2b8;
    }
    
    /* 週末のスタイル */
    .weekend {
        background-color: #fff5f5;
    }
    
    .weekend .workload-input {
        background-color: #ffeaea;
    }
    
    .weekend.has-value .workload-input {
        background-color: #ffdddd;
    }
    
    /* テーブル行のスタイル */
    .workload-table tbody tr {
        background-color: #fff;
    }
    
    .workload-table tbody tr:nth-child(odd) {
        background-color: #f8f9fa;
    }
    
    .workload-table tbody tr:hover {
        background-color: #e2e6ea;
    }
    
    .workload-table tbody tr:hover .department-col,
    .workload-table tbody tr:hover .user-col,
    .workload-table tbody tr:hover .ticket-col,
    .workload-table tbody tr:hover .total-days-col,
    .workload-table tbody tr:hover .total-hours-col {
        background-color: #d6d8db;
    }
    
    /* 課バッジ */
    .department-badge {
        font-size: 0.7em;
        margin-top: 2px;
        padding: 2px 6px;
        border-radius: 10px;
    }
    
    /* チケット情報のスタイル */
    .ticket-info {
        overflow: hidden;
        line-height: 1.3;
    }
    
    .ticket-title {
        font-weight: 600;
        color: #2c3e50;
        display: block;
        margin-bottom: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.85em;
    }
    
    .project-name-small {
        font-size: 0.75em;
        color: #6c757d;
        font-style: italic;
        margin-bottom: 3px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .ticket-badges {
        display: flex;
        gap: 2px;
        flex-wrap: wrap;
    }
    
    .badge-xs {
        font-size: 0.6em;
        padding: 1px 4px;
        border-radius: 6px;
        font-weight: 600;
    }
    .day-header {
        font-size: 0.85em;
        font-weight: bold;
        writing-mode: horizontal-tb;
        text-orientation: mixed;
        height: 50px; /* 高さを少し調整 */
        line-height: 1.3;
        padding: 6px 4px;
        text-align: center;
    }
    
    /* 平日のヘッダー */
    .day-header.weekday {
        background-color: #f8f9fa;
        color: #495057;
    }
    
    /* 土曜日のヘッダー */
    .day-header.saturday {
        background-color: #e3f2fd !important;
        color: #1565c0 !important;
        font-weight: bold;
    }
    
    /* 日曜日・祝日のヘッダー */
    .day-header.holiday {
        background-color: #ffebee !important;
        color: #c62828 !important;
        font-weight: bold;
    }
    
    /* 土曜日のセル */
    .day-cell.saturday {
        background-color: #e3f2fd;
    }
    
    .day-cell.saturday .workload-input {
        background-color: #e3f2fd;
        border-color: #1976d2;
    }
    
    .day-cell.saturday .workload-input:focus {
        background-color: #bbdefb;
        border-color: #1565c0;
    }
    
    .day-cell.saturday .workload-input.has-value {
        background-color: #bbdefb;
        color: #0d47a1;
        font-weight: bold;
    }
    
    /* 日曜日・祝日のセル */
    .day-cell.holiday {
        background-color: #ffebee;
    }
    
    .day-cell.holiday .workload-input {
        background-color: #ffebee;
        border-color: #d32f2f;
    }
    
    .day-cell.holiday .workload-input:focus {
        background-color: #ffcdd2;
        border-color: #c62828;
    }
    
    .day-cell.holiday .workload-input.has-value {
        background-color: #ffcdd2;
        color: #b71c1c;
        font-weight: bold;
    }
    
    /* === 【修正】週末スタイルを土日祝日用に調整 === */
    .weekend {
        background-color: #fff5f5;
    }
    
    .weekend .workload-input {
        background-color: #ffeaea;
    }
    
    .weekend.has-value .workload-input {
        background-color: #ffdddd;
    }

    /* ユーザー情報 */
    .user-info {
        overflow: hidden;
    }
    
    .user-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* テーブルコンテナ */
    .table-responsive {
        max-height: 75vh;
        overflow: auto;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* カスタムスクロールバー */
    .table-responsive::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* 新規行追加フォーム */
    .add-row-form {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px dashed #007bff;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* ボタンスタイル */
    .btn-sm {
        padding: 4px 8px;
        font-size: 0.75em;
        border-radius: 4px;
    }
    
    /* 統計カード */
    .stats-card {
        margin-top: 20px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    /* レスポンシブ対応 */
    @media (max-width: 768px) {
        .workload-table {
            font-size: 0.8em;
        }
        
        .department-col { width: 60px; min-width: 60px; }
        .user-col { width: 80px; min-width: 80px; left: 60px; }
        .ticket-col { width: 120px; min-width: 120px; left: 140px; }
        .total-days-col { left: 260px; }
        .total-hours-col { left: 330px; }
        .day-col { width: 35px; min-width: 35px; }
        .workload-input { width: 30px; height: 26px; }
    }
</style>
{% endblock %}

{% block page_actions %}
<div class="btn-toolbar mb-3">
    <div class="btn-group me-2">
        <input type="month" 
               id="yearMonthPicker" 
               class="form-control" 
               value="{{ year_month }}"
               onchange="changeYearMonth(this.value)">
    </div>
    {% if is_admin %}
        <div class="btn-group me-2">
            <select id="departmentFilter" class="form-select" onchange="filterByDepartment()">
                <option value="">全部署</option>
                {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if dept.id|stringformat:"s" == selected_department %}selected{% endif %}>
                        {{ dept.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="btn-group me-2">
            <select id="sectionFilter" class="form-select" onchange="filterBySection()">
                <option value="">全課</option>
                {% for section in sections %}
                    <option value="{{ section.id }}" {% if section.id|stringformat:"s" == selected_section %}selected{% endif %}>
                        {{ section.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}
    <div class="btn-group">
        <button type="button" class="btn btn-success" onclick="toggleAddForm()">
            <i class="bi bi-plus-circle"></i> 行追加
        </button>
        <button type="button" class="btn btn-primary" onclick="saveAllChanges()">
            <i class="bi bi-save"></i> 一括保存
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- 新規行追加フォーム -->
<div id="addRowForm" class="add-row-form" style="display: none;">
    <h6><i class="bi bi-plus-circle"></i> 新しい工数行を追加</h6>
    <div class="row g-3">
        <div class="col-md-3">
            <label for="newUser" class="form-label">担当者</label>
            <select id="newUser" class="form-select" required>
                <option value="">担当者を選択</option>
                {% for user in all_users %}
                    <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="newProject" class="form-label">案件</label>
            <select id="newProject" class="form-select" required onchange="loadNewTickets()">
                <option value="">案件を選択</option>
                {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">チケット</label>
            <select id="newTicket" class="form-select" required>
                <option value="">案件を先に選択してください</option>
            </select>
        </div>
        <!-- <div class="col-md-3">
            <label for="newSection" class="form-label">担当課</label>
            <select id="newSection" class="form-select">
            <option value="">担当課を選択</option>
            {% for section in sections %}
                <option value="{{ section.id }}">{{ section.name }}</option>
            {% endfor %}
            </select>
        </div> -->
        <!-- <div class="col-md-2">
            <label for="newYearMonth" class="form-label">年月</label>
            <input type="month" id="newYearMonth" class="form-control" value="{{ year_month }}" required>
        </div> -->
        <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid gap-2 d-md-flex">
                <button type="button" class="btn btn-success" onclick="addNewRow()">
                    <i class="bi bi-plus"></i> 追加
                </button>
                <button type="button" class="btn btn-secondary" onclick="toggleAddForm()">
                    <i class="bi bi-x"></i> キャンセル
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 工数入力テーブル -->
<div class="table-responsive">
    <table class="table workload-table">
        <!-- テーブルヘッダー部分 -->
        <thead>
            <tr>
                <th class="department-col sticky-header">課名</th>
                <th class="user-col sticky-header">担当者</th>
                <th class="ticket-col sticky-header">チケット</th>
                <th class="total-days-col sticky-header">人日</th>
                <th class="total-hours-col sticky-header">時間</th>
                
                <!-- === 【修正】曜日付きの日付ヘッダー === -->
                {% for day in day_range %}
                    {% with day_info=weekday_info|default:"{}"|get_item:day %}
                        <th class="day-header day-col {{ day_info.is_saturday|yesno:'saturday,weekday' }}{{ day_info.is_holiday|yesno:' holiday,' }}{{ day_info.is_sunday|yesno:' holiday,' }}">
                            <div>{{ day }}</div>
                            <small>
                                {% if day_info.weekday == 0 %}月
                                {% elif day_info.weekday == 1 %}火
                                {% elif day_info.weekday == 2 %}水
                                {% elif day_info.weekday == 3 %}木
                                {% elif day_info.weekday == 4 %}金
                                {% elif day_info.weekday == 5 %}土
                                {% elif day_info.weekday == 6 %}日
                                {% else %}{{ day_info.weekday }}
                                {% endif %}
                            </small>
                        </th>
                    {% endwith %}
                {% endfor %}
                
                <th class="action-col sticky-header">操作</th>
            </tr>
        </thead>

        <!-- テーブルボディ部分 -->
        <tbody>
            {% for workload in workloads %}
                <tr class="workload-row" data-workload-id="{{ workload.id }}">
                    <!-- 課名 -->
                    <td class="department-col">
                        {% if workload.user.section %}
                            <span class="badge bg-info department-badge" title="{{ workload.user.section.department.name }}">
                                {{ workload.user.section.name }}
                            </span>
                        {% elif workload.user.department %}
                            <span class="badge bg-warning department-badge">
                                {{ workload.user.department.name }}
                            </span>
                        {% else %}
                            <span class="text-muted">未設定</span>
                        {% endif %}
                    </td>
                    
                    <!-- 担当者 -->
                    <td class="user-col">
                        <div class="user-info">
                            <span class="user-name" title="{{ workload.user.get_full_name|default:workload.user.username }}">
                                {{ workload.user.get_full_name|default:workload.user.username|truncatechars:12 }}
                            </span>
                        </div>
                    </td>
                    
                    <!-- チケット -->
                    <td class="ticket-col">
                        {% if workload.ticket %}
                            <div class="ticket-info">
                                <span class="ticket-title" title="{{ workload.ticket.title }}">
                                    {{ workload.ticket.title|truncatechars:25 }}
                                </span>
                                <span class="project-name-small" title="{{ workload.project.name }}">
                                    {{ workload.project.name|truncatechars:20 }}
                                </span>
                                <div class="ticket-badges">
                                    {% with priority_info=workload.ticket.get_priority_display_with_color %}
                                        <span class="badge bg-{{ priority_info.color }} badge-xs" title="優先度: {{ priority_info.text }}">
                                            {% if priority_info.text == "低" %}L
                                            {% elif priority_info.text == "通常" %}N
                                            {% elif priority_info.text == "高" %}H
                                            {% elif priority_info.text == "緊急" %}U
                                            {% else %}{{ priority_info.text|slice:":1" }}
                                            {% endif %}
                                        </span>
                                    {% endwith %}
                                    {% with status_info=workload.ticket.get_status_display_with_color %}
                                        <span class="badge bg-{{ status_info.color }} badge-xs" title="ステータス: {{ status_info.text }}">
                                            {% if status_info.text == "オープン" %}OP
                                            {% elif status_info.text == "進行中" %}PR
                                            {% elif status_info.text == "レビュー" %}RV
                                            {% elif status_info.text == "完了" %}CL
                                            {% else %}{{ status_info.text|slice:":2" }}
                                            {% endif %}
                                        </span>
                                    {% endwith %}
                                </div>
                            </div>
                        {% else %}
                            <div class="ticket-info">
                                <span class="ticket-title text-muted">チケット未設定</span>
                            </div>
                        {% endif %}
                    </td>
                    
                    <!-- 合計人日 -->
                    <td class="total-days-col">
                        <span title="合計人日: {{ workload.total_days }}">{{ workload.total_days|floatformat:1 }}</span>
                    </td>
                    
                    <!-- 合計時間 -->
                    <td class="total-hours-col">
                        <span title="合計時間: {{ workload.total_hours }}">{{ workload.total_hours|floatformat:1 }}</span>
                    </td>
                    
                    <!-- 各日の工数入力 -->
                    {% for day in day_range %}
                        <td class="day-cell {{ day|get_weekday_class:weekday_info }}">
                            <input type="number" 
                                   class="workload-input {% if workload|get_day_value:day > 0 %}has-value{% endif %}" 
                                   data-workload-id="{{ workload.id }}" 
                                   data-day="{{ day }}"
                                   value="{% if workload|get_day_value:day > 0 %}{{ workload|get_day_value:day|floatformat:1 }}{% endif %}"
                                   min="0" 
                                   max="24" 
                                   title="{{ year }}/{{ month }}/{{ day }} の工数 ({% if day|is_weekend_or_holiday:weekday_info %}{% if day|get_weekday_class:weekday_info == 'saturday' %}土曜日{% else %}日曜・祝日{% endif %}{% else %}平日{% endif %})"
                                   placeholder="">
                        </td>
                    {% endfor %}
                    
                    <!-- 操作 -->
                    <td class="action-col">
                        <button type="button" 
                                class="btn btn-sm delete-workload-btn" 
                                data-workload-id="{{ workload.id }}"
                                title="この工数行を削除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="{{ days_in_month|add:6 }}" class="text-center text-muted py-5">
                        <i class="bi bi-calendar-x fs-1 d-block mb-3 text-muted"></i>
                        <h5>工数データがありません</h5>
                        <p class="mb-3">新しい工数行を追加して工数入力を開始してください。</p>
                        <button type="button" class="btn btn-primary btn-lg" onclick="toggleAddForm()">
                            <i class="bi bi-plus-circle"></i> 工数行を追加
                        </button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 統計情報 -->
<div class="row stats-card">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-value" id="total-hours-stat">0.0</div>
                            <div class="stat-label">合計時間</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-value" id="total-days-stat">0.0</div>
                            <div class="stat-label">合計人日</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-value" id="total-workloads-stat">0</div>
                            <div class="stat-label">工数行数</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRFトークン取得
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 新規行追加フォームの表示/非表示
function toggleAddForm() {
    const addForm = document.getElementById('addRowForm');
    if (addForm) {
        if (addForm.style.display === 'none' || addForm.style.display === '') {
            addForm.style.display = 'block';
            // フォームが表示されたら最初のフィールドにフォーカス
            const firstInput = addForm.querySelector('select, input');
            if (firstInput) {
                firstInput.focus();
            }
        } else {
            addForm.style.display = 'none';
            // フォームを閉じる時にリセット
            resetAddForm();
        }
    }
}

// 新規行追加フォームのリセット
function resetAddForm() {
    const form = document.getElementById('addRowForm');
    if (form) {
        // 全ての選択肢をリセット
        const selects = form.querySelectorAll('select');
        selects.forEach(select => {
            select.selectedIndex = 0;
        });
        
        // チケット選択肢をリセット
        const ticketSelect = document.getElementById('newTicket');
        if (ticketSelect) {
            ticketSelect.innerHTML = '<option value="">案件を先に選択してください</option>';
        }
    }
}

// 新規行追加
function addNewRow() {
    const userId = document.getElementById('newUser').value;
    const projectId = document.getElementById('newProject').value;
    const ticketId = document.getElementById('newTicket').value;
    
    // バリデーション
    if (!userId) {
        alert('担当者を選択してください。');
        document.getElementById('newUser').focus();
        return;
    }
    
    if (!projectId) {
        alert('案件を選択してください。');
        document.getElementById('newProject').focus();
        return;
    }
    
    if (!ticketId) {
        alert('チケットを選択してください。');
        document.getElementById('newTicket').focus();
        return;
    }
    
    // 現在の年月を取得
    const yearMonth = document.getElementById('yearMonthPicker').value;
    
    // 新規工数行を作成
    fetch('{% url "workloads:create_workload_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            user_id: userId,
            project_id: projectId,
            ticket_id: ticketId,
            year_month: yearMonth
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ページをリロードして新しい行を表示
            showSuccessMessage('新しい工数行を追加しました。');
            
            // フォームを閉じる
            toggleAddForm();
            
            // 少し遅延してからページリロード
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('エラー: ' + (data.error || '工数行の追加に失敗しました。'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。');
    });
}

// 一括保存機能
function saveAllChanges() {
    const changedInputs = [];
    
    // 変更された入力フィールドを収集
    document.querySelectorAll('.workload-input').forEach(input => {
        const originalValue = input.getAttribute('data-original-value') || '0';
        const currentValue = input.value || '0';
        
        if (originalValue !== currentValue) {
            changedInputs.push({
                workload_id: input.dataset.workloadId,
                day: input.dataset.day,
                value: currentValue
            });
        }
    });
    
    if (changedInputs.length === 0) {
        showSuccessMessage('変更はありません。');
        return;
    }
    
    // 一括保存API呼び出し
    fetch('{% url "workloads:bulk_update_workload_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            changes: changedInputs
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`${changedInputs.length}件の変更を保存しました。`);
            
            // 元の値を更新
            changedInputs.forEach(change => {
                const input = document.querySelector(
                    `input[data-workload-id="${change.workload_id}"][data-day="${change.day}"]`
                );
                if (input) {
                    input.setAttribute('data-original-value', change.value);
                }
            });
        } else {
            alert('エラー: ' + (data.error || '一括保存に失敗しました。'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('一括保存中にエラーが発生しました。');
    });
}

// 削除ボタンの初期化
function initDeleteButtons() {
    document.querySelectorAll('.delete-workload-btn').forEach(button => {
        button.addEventListener('click', handleDeleteWorkload);
    });
}

// 工数行削除処理
function handleDeleteWorkload(event) {
    const button = event.target.closest('.delete-workload-btn');
    if (!button) return;
    
    const workloadId = button.dataset.workloadId;
    
    if (!confirm('この工数行を削除してもよろしいですか？')) {
        return;
    }
    
    fetch('{% url "workloads:delete_workload_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            workload_id: workloadId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 該当行を削除
            const row = button.closest('tr');
            if (row) {
                row.remove();
                showSuccessMessage('工数行を削除しました。');
                updateGlobalStatistics();
            }
        } else {
            alert('エラー: ' + (data.error || '削除に失敗しました。'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('削除中にエラーが発生しました。');
    });
}

// 年月変更
function changeYearMonth(yearMonth) {
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    
    // year_monthパラメータを更新
    params.set('year_month', yearMonth);
    
    // 現在のフィルター値を保持
    const departmentFilter = document.getElementById('departmentFilter');
    const sectionFilter = document.getElementById('sectionFilter');
    
    if (departmentFilter && departmentFilter.value) {
        params.set('department', departmentFilter.value);
    }
    
    if (sectionFilter && sectionFilter.value) {
        params.set('section', sectionFilter.value);
    }
    
    // ページ遷移
    window.location.href = url.pathname + '?' + params.toString();
}

// 部署フィルター
function filterByDepartment() {
    const departmentId = document.getElementById('departmentFilter').value;
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    
    if (departmentId) {
        params.set('department', departmentId);
    } else {
        params.delete('department');
    }
    
    // セクションフィルターをリセット
    params.delete('section');
    
    window.location.href = url.pathname + '?' + params.toString();
}

// 課フィルター
function filterBySection() {
    const sectionId = document.getElementById('sectionFilter').value;
    const url = new URL(window.location);
    const params = new URLSearchParams(url.search);
    
    if (sectionId) {
        params.set('section', sectionId);
    } else {
        params.delete('section');
    }
    
    window.location.href = url.pathname + '?' + params.toString();
}

// 工数入力の初期化
function initWorkloadInputs() {
    document.querySelectorAll('.workload-input').forEach(function(input) {
        // 元の値を保存（一括保存用）
        input.setAttribute('data-original-value', input.value || '0');
        
        // 既存のイベントリスナーを削除
        input.removeEventListener('change', handleWorkloadChange);
        input.removeEventListener('blur', handleWorkloadBlur);
        
        // 新しいイベントリスナーを追加
        input.addEventListener('change', handleWorkloadChange);
        input.addEventListener('blur', handleWorkloadBlur);
        
        // 初期値がある場合のスタイル適用
        updateInputStyle(input);
    });
}

// 工数変更イベントハンドラー
function handleWorkloadChange(event) {
    const input = event.target;
    const workloadId = input.dataset.workloadId;
    const day = input.dataset.day;
    let value = input.value;
    
    // 空文字の場合は0に設定
    if (value === '' || value === null || value === undefined) {
        value = 0;
    }
    
    // 値の範囲チェック
    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue < 0 || numValue > 24) {
        alert('工数は0-24の範囲で入力してください');
        input.focus();
        return;
    }
    
    updateWorkload(workloadId, day, value);
}

// フォーカスアウトイベントハンドラー
function handleWorkloadBlur(event) {
    const input = event.target;
    updateInputStyle(input);
}

// 入力フィールドのスタイル更新
function updateInputStyle(input) {
    const value = parseFloat(input.value || 0);
    if (value > 0) {
        input.classList.add('has-value');
    } else {
        input.classList.remove('has-value');
    }
}

// 工数更新AJAX
function updateWorkload(workloadId, day, value) {
    fetch('{% url "workloads:update_workload_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            workload_id: workloadId,
            day: day,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 該当行の合計時間・人日を更新
            updateRowTotals(workloadId, data.total_hours, data.total_days);
            
            // 全体統計を更新
            updateGlobalStatistics();
        } else {
            alert('エラー: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。');
    });
}

// 行の合計値を更新
function updateRowTotals(workloadId, totalHours, totalDays) {
    // 該当する行を特定
    const workloadRow = document.querySelector(`tr[data-workload-id="${workloadId}"]`);
    if (!workloadRow) {
        // data-workload-idがtr要素にない場合、input要素から行を特定
        const inputElement = document.querySelector(`input[data-workload-id="${workloadId}"]`);
        if (inputElement) {
            const row = inputElement.closest('tr');
            if (row) {
                updateRowTotalsInRow(row, totalHours, totalDays);
            }
        }
    } else {
        updateRowTotalsInRow(workloadRow, totalHours, totalDays);
    }
}

// 指定された行の合計値を更新
function updateRowTotalsInRow(row, totalHours, totalDays) {
    const totalHoursCell = row.querySelector('.total-hours-col');
    const totalDaysCell = row.querySelector('.total-days-col');
    
    if (totalHoursCell) {
        totalHoursCell.textContent = totalHours.toFixed(1);
    }
    if (totalDaysCell) {
        totalDaysCell.textContent = totalDays.toFixed(1);
    }
}

// 全体統計を更新
function updateGlobalStatistics() {
    let totalHours = 0;
    let totalDays = 0;
    let totalWorkloads = 0;
    
    // 全ての工数入力値を合計
    document.querySelectorAll('.workload-input').forEach(input => {
        const value = parseFloat(input.value || 0);
        if (value > 0) {
            totalHours += value;
        }
    });
    
    totalDays = totalHours / 8;
    
    // 工数行数を計算
    const uniqueWorkloadIds = new Set();
    document.querySelectorAll('.workload-input').forEach(input => {
        if (input.dataset.workloadId) {
            uniqueWorkloadIds.add(input.dataset.workloadId);
        }
    });
    totalWorkloads = uniqueWorkloadIds.size;
    
    // 統計表示を更新
    const statsElements = {
        totalHours: document.querySelector('#total-hours-stat'),
        totalDays: document.querySelector('#total-days-stat'),
        totalWorkloads: document.querySelector('#total-workloads-stat')
    };
    
    if (statsElements.totalHours) {
        statsElements.totalHours.textContent = totalHours.toFixed(1);
    }
    if (statsElements.totalDays) {
        statsElements.totalDays.textContent = totalDays.toFixed(1);
    }
    if (statsElements.totalWorkloads) {
        statsElements.totalWorkloads.textContent = totalWorkloads;
    }
}

// 新規チケット読み込み（既存のコード）
function loadNewTickets() {
    const projectId = document.getElementById('newProject').value;
    const ticketSelect = document.getElementById('newTicket');
    
    if (!projectId) {
        ticketSelect.innerHTML = '<option value="">案件を先に選択してください</option>';
        return;
    }
    
    ticketSelect.innerHTML = '<option value="">読み込み中...</option>';
    
    // URLを修正: 正しいエンドポイントを使用
    fetch(`/projects/api/${projectId}/tickets/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // レスポンスがJSONかどうかチェック
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('レスポンスがJSON形式ではありません');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data);
        
        if (data.success) {
            ticketSelect.innerHTML = '<option value="">チケットを選択</option>';
            
            if (data.tickets && data.tickets.length > 0) {
                data.tickets.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = ticket.id;
                    option.textContent = ticket.title;
                    option.title = ticket.description || ''; // ツールチップに説明を表示
                    ticketSelect.appendChild(option);
                });
            } else {
                ticketSelect.innerHTML = '<option value="">このプロジェクトにはチケットがありません</option>';
            }
        } else {
            console.error('API Error:', data.error);
            ticketSelect.innerHTML = '<option value="">チケットの読み込みに失敗しました</option>';
            showErrorMessage(data.error || 'チケットの読み込みに失敗しました');
        }
    })
    .catch(error => {
        console.error('Fetch Error:', error);
        ticketSelect.innerHTML = '<option value="">エラーが発生しました</option>';
        showErrorMessage(`チケット読み込みエラー: ${error.message}`);
    });
}

// エラーメッセージ表示関数
function showErrorMessage(message) {
    // 既存のメッセージを削除
    const existingAlert = document.querySelector('.alert-danger-custom');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // 新しいメッセージを作成
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-danger-custom alert-dismissible fade show';
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    alertDiv.innerHTML = `
        <i class="bi bi-exclamation-triangle-fill me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 5秒後に自動削除
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// 成功メッセージ表示関数
function showSuccessMessage(message) {
    // 既存のメッセージを削除
    const existingAlert = document.querySelector('.alert-success-custom');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // 新しいメッセージを作成
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-success-custom alert-dismissible fade show';
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    alertDiv.innerHTML = `
        <i class="bi bi-check-circle-fill me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 3秒後に自動削除
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    initWorkloadInputs();
    initDeleteButtons();
    updateGlobalStatistics();
    
    // プロジェクト選択時の初期化
    const projectSelect = document.getElementById('newProject');
    if (projectSelect) {
        projectSelect.addEventListener('change', loadNewTickets);
    }
    
    console.log('工数カレンダー初期化完了');
});

// 動的に追加された要素に対するイベント委譲
document.addEventListener('change', function(event) {
    if (event.target.classList.contains('workload-input')) {
        handleWorkloadChange(event);
    }
});

document.addEventListener('blur', function(event) {
    if (event.target.classList.contains('workload-input')) {
        handleWorkloadBlur(event);
    }
}, true);

document.addEventListener('click', function(event) {
    if (event.target.closest('.delete-workload-btn')) {
        handleDeleteWorkload(event);
    }
});
</script>
{% endblock %}